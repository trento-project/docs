include::product-attributes.adoc[]

[[sec-trento-k8s-deployment]]
=== {k8s} deployment
:revdate: 2025-10-31

The subsection uses the following placeholders:

* `TRENTO_SERVER_HOSTNAME`: the host name used by the end user to access the console.
* `ADMIN_PASSWORD`: the password of the admin user created during the installation process.
+
The password must meet the following requirements:
+
- minimum length of 8 characters
- the password must not contain 3 identical numbers or letters in a row (for example, 111 or aaa)
- the password must not contain 4 sequential numbers or letters (for example, 1234, abcd, ABCD)

[IMPORTANT]
====
By default, the provided Helm chart uses link:https://github.com/traefik/traefik[Traefik] as ingress class +
Main usages are related to:

 * path rewriting
 * endpoint protection

Find traefik specific usages link:https://github.com/search?q=repo%3Atrento-project%2Fhelm-charts+traefik&type=code[here], and in case another ingress controller is used, please adapt accordingly.
====

[[sec-trento-install-trentoserver-on-existing-k8s-cluster]]
==== Installing {trserver} on an existing {k8s} cluster

{trserver} consists of a several components delivered as container images and intended for deployment on a {k8s} cluster. A manual production-ready deployment of these components requires {k8s} knowledge. Customers without in-house {k8s} expertise and those who want to try {trento} with a minimum of effort, can use the {trento} Helm chart. This approach automates the deployment of all the required components on a single {k8s} cluster node. You can use the {trento} Helm chart to install {trserver} on a existing {k8s} cluster as follows:

. Install Helm:
+
====
[source,bash,subs="attributes"]
----
curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
----
====
+
. Connect Helm to an existing {k8s} cluster.
. Use Helm to install {trserver} with the {trento} Helm chart:
+
====
[source,bash,subs="attributes"]
----
helm upgrade \
   --install trento-server oci://registry.suse.com/trento/trento-server \
   --set global.trentoWeb.origin=TRENTO_SERVER_HOSTNAME \
   --set trento-web.adminUser.password=ADMIN_PASSWORD
----
====
+
When using a Helm version lower than 3.8.0, an experimental flag must be set as follows:
+
====
[source,bash]
----
HELM_EXPERIMENTAL_OCI=1 helm upgrade \
   --install trento-server oci://registry.suse.com/trento/trento-server \
   --set global.trentoWeb.origin=TRENTO_SERVER_HOSTNAME \
   --set trento-web.adminUser.password=ADMIN_PASSWORD
----
====
+
. To verify that the {trserver} installation was successful, open the URL of the {tr_web} (`http://TRENTO_SERVER_HOSTNAME`) from a workstation on the {sap} administrator's LAN.

[[sec-trento-install-trentoserver-on-k3s]]
==== Installing {trserver} on K3s

If you do not have a {k8s} cluster, or you have one but you do not want to use it for {trento}, you can use {suse} Rancher's K3s as an alternative. To deploy {trserver} on K3s, you need a server or VM (see <<sec-trento-server-requirements>> for minimum requirements) and follow steps in <<pro-trento-manually-installing>>.

[IMPORTANT]
====
The following procedure deploys {trserver} on a single-node K3s cluster. Note that this setup is not recommended for production use.
====

[[pro-trento-manually-installing]]
===== Manually installing Trento on a {trserver} host

. Log in to the {trserver} host.
+
[[st-install-k3s]]
. Install K3s either as {rootuser} or a non-{rootuser} user.
+
* Installing as user {rootuser}:
+
====
[source,subs="attributes"]
----
curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_SELINUX_RPM=true sh
----
====
+
* Installing as a non-{rootuser} user:
+
====
[source,bash,subs="attributes"]
----
curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_SELINUX_RPM=true sh -s - --write-kubeconfig-mode 644
----
====
+
[[st-install-helm]]
. Install Helm as {rootuser}.
+
====
[source,subs="attributes"]
----
curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
----
====
+
. Set the `KUBECONFIG` environment variable for the same user that installed K3s:
+
====
[source,bash]
----
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
----
====
+
[[st-deploy-k3s]]
. With the same user that installed K3s, install {trserver} using the Helm chart:
+
====
[source,bash]
----
helm upgrade \
   --install trento-server oci://registry.suse.com/trento/trento-server \
   --set global.trentoWeb.origin=TRENTO_SERVER_HOSTNAME \
   --set trento-web.adminUser.password=ADMIN_PASSWORD
----
====
When using a Helm version lower than 3.8.0, an experimental flag must be set as follows:
+
====
[source,bash]
----
HELM_EXPERIMENTAL_OCI=1 helm upgrade \
   --install trento-server oci://registry.suse.com/trento/trento-server \
   --set global.trentoWeb.origin=TRENTO_SERVER_HOSTNAME \
   --set trento-web.adminUser.password=ADMIN_PASSWORD
----
====
+
. Monitor the creation and start-up of the {trserver} pods, and wait until they are ready and running:
+
====
[source,bash]
----
watch kubectl get pods
----
====
+
All pods must be in the ready and running state.
+
. Log out of the {trserver} host.
. To verify that the {trserver} installation was successful, open the URL of the {tr_web} (`http://TRENTO_SERVER_HOSTNAME`) from a workstation on the {sap} administrator's LAN.

[[sec-trento-deploying-trento-on-selected-nodes]]
==== Deploying {trserver} on selected nodes

If you use a multi-node {k8s} cluster, it is possible to deploy {trserver} images on selected nodes by specifying the field `nodeSelector` in the helm upgrade command as follows:
====
[source,bash]
----
HELM_EXPERIMENTAL_OCI=1 helm upgrade \
   --install trento-server oci://registry.suse.com/trento/trento-server \
   --set global.trentoWeb.origin=TRENTO_SERVER_HOSTNAME \
   --set trento-web.adminUser.password=ADMIN_PASSWORD \
   --set prometheus.server.nodeSelector.LABEL=VALUE \
   --set postgresql.primary.nodeSelector.LABEL=VALUE \
   --set trento-web.nodeSelector.LABEL=VALUE \
   --set trento-runner.nodeSelector.LABEL=VALUE
----
====

[[helm-event-pruning]]
==== Configuring event pruning
:revdate: 2025-05-23


The event pruning feature allows administrators to manage how long registered events are stored in the database and how often the expired events are removed.

The following configuration options are available:

`pruneEventsOlderThan`::
The number of days registered events are stored in the database. The default value is *10*. _Keep in mind that `pruneEventsOlderThan` can be set to *0*. However, this deletes all events whenever the cron job runs, making it impossible to analyze and troubleshoot issues with the application_

`pruneEventsCronjobSchedule`::
The frequency of the cron job that deletes expired events. The default value is *"0 0 * * *"*, which runs daily at midnight.

To modify the default values, execute the following Helm command:

[source,bash]
----
helm ... \
    --set trento-web.pruneEventsOlderThan=<<EXPIRATION_IN_DAYS>> \
    --set trento-web.pruneEventsCronjobSchedule="<<NEW_SCHEDULE>>"
----

Replace the placeholders with the desired values:

`EXPIRATION_IN_DAYS`::
Number of days to retain events in the database before pruning.

`NEW_SCHEDULE`::
The cron rule specifying how frequently the pruning job is performed.

*Example* command to retain events for 30 days and schedule pruning daily at 3 AM:

[source,bash]
----
helm upgrade \
  --install trento-server oci://registry.suse.com/trento/trento-server \
  --set global.trentoWeb.origin=TRENTO_SERVER_HOSTNAME \
  --set trento-web.adminUser.password=ADMIN_PASSWORD \
  --set trento-web.pruneEventsOlderThan=30 \
  --set trento-web.pruneEventsCronjobSchedule="0 3 * * *"
----

[[sec-trento-enabling-email-alerts]]
==== Enabling email alerts

Email alerting feature notifies the {sap} Basis administrator about important changes in the {sap} Landscape being monitored by {trento}.

The reported events include the following:

* Host heartbeat failed
* Cluster health detected critical
* Database health detected critical
* {sap} System health detected critical

This feature is disabled by default. It can be enabled at installation time or anytime at a later stage. In both cases, the procedure is the same and uses the following placeholders:

`SMTP_SERVER`::
The SMTP server designated to send email alerts

`SMTP_PORT`::
Port on the SMTP server

`SMTP_USER`::
User name to access SMTP server

`SMTP_PASSWORD`::
Password to access SMTP server

`ALERTING_SENDER`::
Sender email for alert notifications

`ALERTING_RECIPIENT`::
Email address to receive alert notifications.

The command to enable email alerts is as follows:

[source,bash]
----
HELM_EXPERIMENTAL_OCI=1 helm upgrade \
   --install trento-server oci://registry.suse.com/trento/trento-server \
   --set global.trentoWeb.origin=TRENTO_SERVER_HOSTNAME \
   --set trento-web.adminUser.password=ADMIN_PASSWORD \
   --set trento-web.alerting.enabled=true \
   --set trento-web.alerting.smtpServer=SMTP_SERVER \
   --set trento-web.alerting.smtpPort=SMTP_PORT \
   --set trento-web.alerting.smtpUser=SMTP_USER \
   --set trento-web.alerting.smtpPassword=SMTP_PASSWORD \
   --set trento-web.alerting.sender=ALERTING_SENDER \
   --set trento-web.alerting.recipient=ALERTING_RECIPIENT
----

[[sec-trento-enabling-ssl]]
==== Enabling SSL

Ingress may be used to provide SSL termination for the Web component of {trserver}. This would allow to encrypt the communication from the agent to the server, which is already secured by the corresponding API key. It would also allow HTTPS access to the Web console with trusted certificates.

Configuration must be done in the tls section of the `values.yaml` file of the chart of the {trserver} Web component.

For details on the required Ingress setup and configuration, refer to: https://kubernetes.io/docs/concepts/services-networking/ingress/. Particularly, refer to section https://kubernetes.io/docs/concepts/services-networking/ingress/#tls for details on the secret format in the YAML configuration file.

Additional steps are required on the Agent side.
// toms 2022-09-14: which steps?

// [[sec-trento-mcp-server-k8s]]
// ==== Installing {trento} MCP Server (Optional)
// 
// The {trento} MCP Server provides AI-assisted management capabilities for your SAP landscape by exposing {trento} functionality through the Model Context Protocol (MCP). This optional component enables integration with AI tools and assistants.
// 
// [NOTE]
// ====
// The {trento} MCP Server is an optional component. The core {trserver} functionality works independently without it.
// 
// After installation, see <<sec-trento-using-mcp-server>> for instructions on how to connect MCP-compatible AI assistants and tools to your Trento Server.
// ====
// 
// ===== Prerequisites
// 
// Before installing the {trento} MCP Server, ensure you have:
// 
// * A running {trserver} installation (Web and Wanda components).
// +
// The Trento Server consists of multiple components:
// +
// ** *Web component*: Provides the user interface and API endpoints for managing SAP systems
// ** *Wanda component*: Handles automated checks and compliance validation for SAP landscapes
// +
// Both components must be running and accessible for the MCP Server to function properly.
// 
// * Network connectivity between the MCP Server and Trento Server components.
// * Access to the Trento Server URL (especially important when deployed behind NGINX or other reverse proxies).
// 
// ===== Configuration Overview
// 
// The {trento} MCP Server requires minimal configuration, but needs to know how to reach your Trento Server. The key configuration parameters are:
// 
// * `TRENTO_URL`: The URL where your Trento Server is accessible. This is particularly important when Trento is deployed behind NGINX or other reverse proxies. Use the externally accessible URL (e.g., `https://trento.example.com`) rather than internal service URLs. When set, the server will use this URL for OpenAPI specification autodiscovery.
// 
// * `OAS_PATH`: Explicit paths to OpenAPI specification files. Use this when you want to directly specify the location of the API specifications instead of relying on autodiscovery. This is particularly useful when you want to connect to internal services (such as `localhost` or Kubernetes service names) instead of going through a reverse proxy.
// 
// ===== Enabling the MCP Server
// 
// When installing the complete {trserver} using Helm, the MCP Server is disabled by default. Enable it by passing `--set trento-mcp-server.enabled=true`:
// 
// ====
// [source,bash]
// ----
// helm upgrade --install trento-server oci://registry.suse.com/trento/trento-server \
//   --set trento-web.trentoWebOrigin=TRENTO_SERVER_HOSTNAME \
//   --set trento-web.adminUser.password=ADMIN_PASSWORD \
//   --set trento-mcp-server.enabled=true
// ----
// ====
// 
// [NOTE]
// ====
// The examples in this guide do not specify a Kubernetes namespace for simplicity. By default, Helm will install to the `default` namespace. For production deployments, create and use a dedicated namespace:
// 
// [source,bash]
// ----
// kubectl create namespace trento
// helm upgrade --install trento-server oci://registry.suse.com/trento/trento-server \
//   --namespace trento \
//   --set trento-mcp-server.enabled=true \
//   ...
// ----
// ====
// 
// The MCP Server will automatically connect to the {tr_web} and Wanda internal services within the {k8s} cluster.
// 
// ===== MCP Server Configuration Options
// 
// The {trento} MCP Server Helm chart supports various configuration options:
// 
// ====== Customize Ingress Path
// 
// By default, ingress is enabled. To customize the ingress configuration:
// 
// ====
// [source,bash]
// ----
// helm upgrade --install trento-server oci://registry.suse.com/trento/trento-server \
//   --set trento-mcp-server.enabled=true \
//   --set trento-mcp-server.ingress.enabled=true \
//   --set trento-mcp-server.ingress.hosts[0].host=TRENTO_SERVER_HOSTNAME \
//   --set trento-mcp-server.ingress.hosts[0].paths[0].path=/mcp-server-trento \
//   --set trento-mcp-server.ingress.hosts[0].paths[0].pathType=ImplementationSpecific
// ----
// ====
// 
// The MCP Server endpoint will be: `https://TRENTO_SERVER_HOSTNAME/mcp-server-trento/mcp`
// 
// ====== Disabling Tag Filtering
// 
// By default, only operations tagged with `MCP` are exposed. To expose all operations and remove tag filtering:
// 
// ====
// [source,bash]
// ----
// helm upgrade --install trento-server oci://registry.suse.com/trento/trento-server \
//   --set trento-mcp-server.enabled=true \
//   --set trento-mcp-server.mcpServer.tagFilter=[]
// ----
// ====
// 
// [NOTE]
// ====
// You can also filter by different tags by setting `--set trento-mcp-server.mcpServer.tagFilter[0]=YourTag`.
// ====
// 
// ====== Adjust Log Verbosity
// 
// The default log level is `info`. Adjust it for debugging:
// 
// ====
// [source,bash]
// ----
// helm upgrade --install trento-server oci://registry.suse.com/trento/trento-server \
//   --set trento-mcp-server.enabled=true \
//   --set trento-mcp-server.mcpServer.verbosity=debug
// ----
// ====
// 
// ====== Adjust Resource Limits
// 
// For production deployments with different resource requirements:
// 
// ====
// [source,bash]
// ----
// helm upgrade --install trento-server oci://registry.suse.com/trento/trento-server \
//   --set trento-mcp-server.enabled=true \
//   --set trento-mcp-server.resources.requests.cpu=100m \
//   --set trento-mcp-server.resources.requests.memory=128Mi \
//   --set trento-mcp-server.resources.limits.cpu=1000m \
//   --set trento-mcp-server.resources.limits.memory=1Gi
// ----
// ====
// 
// ====== Disabling Health Check Probes
// 
// Health check probes are enabled by default. To disable them if needed:
// 
// ====
// [source,bash]
// ----
// helm upgrade --install trento-server oci://registry.suse.com/trento/trento-server \
//   --set trento-mcp-server.enabled=true \
//   --set trento-mcp-server.livenessProbe.enabled=false \
//   --set trento-mcp-server.readinessProbe.enabled=false
// ----
// ====
// 
// ====== Complete Configuration Example
// 
// Here is a complete example that configures external access via a custom ingress path:
// 
// ====
// [source,bash]
// ----
// helm upgrade --install trento-server oci://registry.suse.com/trento/trento-server \
//   --set trento-web.trentoWebOrigin=https://trento.example.com \
//   --set trento-web.adminUser.password=SecurePassword123 \
//   --set trento-mcp-server.enabled=true \
//   --set trento-mcp-server.mcpServer.trentoURL=https://trento.example.com \
//   --set trento-mcp-server.ingress.hosts[0].host=trento.example.com \
//   --set trento-mcp-server.ingress.hosts[0].paths[0].path=/mcp-server-trento \
//   --set trento-mcp-server.ingress.hosts[0].paths[0].pathType=ImplementationSpecific
// ----
// ====
// 
// ===== Verifying the MCP Server Installation
// 
// . Check that the MCP Server pod is running:
// +
// ====
// [source,bash]
// ----
// kubectl get pods -l app.kubernetes.io/name=mcp-server
// ----
// ====
// +
// Expected output:
// +
// ====
// [source,bash]
// ----
// NAME                                       READY   STATUS    RESTARTS   AGE
// trento-server-mcp-server-xxxxxxxxxx-xxxxx  1/1     Running   0          2m
// ----
// ====
// +
// . Check the logs:
// +
// ====
// [source,bash]
// ----
// kubectl logs -l app.kubernetes.io/name=mcp-server
// ----
// ====
// +
// . If health checks are enabled, verify the health endpoints:
// +
// ====
// [source,bash]
// ----
// # Expose the health check port from the Pod, as it is not exposed as a Kubernetes Service.
// kubectl port-forward --namespace default $(kubectl get pods --namespace default -l app.kubernetes.io/name=mcp-server -o jsonpath="{.items[0].metadata.name}") 8080:8080
// 
// # Liveness endpoint:
// curl http://localhost:8080/livez
// 
// # Example output:
// # {"info":{"name":"trento-mcp-server","version":"0.1.0"},"status":"up"}
// 
// # Readiness endpoint:
// curl http://localhost:8080/readyz
// 
// # Example output:
// # {"status":"up","details":{"mcp-server":{"status":"up","timestamp":"2025-10-09T12:11:09.528898849Z"},"wanda-api":{"status":"up","timestamp":"2025-10-09T12:11:09.544855047Z"},"web-api":{"status":"up","timestamp":"2025-10-09T12:11:09.544855047Z"}}}
// ----
// ====
// 